# Maintainer: Ivailo Monev <xakepa10@gmail.com>

version=4.9.0
release=1
description='C++ toolkit derived from the Qt 4.8 framework'
depends=('libtiff' 'libpng' 'libmng' 'sqlite' 'ca-certificates' 'glib' 'dbus'
        'fontconfig' 'xorg-libraries' 'alsa-lib' 'icu' 'hicolor-icon-theme'
        'mesalib' 'cups')
makedepends=('python')
optdepends=('gtk2' 'mariadb' 'unixodbc' 'postgresql' 'nas')
sources=("https://github.com/fluxer/katie.git")

src_prepare() {
    echo 'set(LDCONF_INSTALL_DIR /etc/ld.so.conf.d)' \
        >> katie.git/mkspecs/linux/vendor.cmake
    echo 'set(PROFILE_INSTALL_DIR /etc/profile.d)' \
        >> katie.git/mkspecs/linux/vendor.cmake
    echo 'set(CMAKE_INSTALL_DIR /usr/share/cmake)' \
        >> katie.git/mkspecs/linux/vendor.cmake
}

src_compile() {
    mkdir -p build && cd build

    cmake ../katie.git \
         -Wno-dev \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DWITH_GTK2=$OPTIONAL_GTK2_BOOL \
        -DWITH_MYSQL=$OPTIONAL_MARIADB_BOOL \
        -DWITH_ODBC=$OPTIONAL_UNIXODBC_BOOL \
        -DWITH_PSQL=$OPTIONAL_POSTGRESQL_BOOL \
        -DWITH_NAS=$OPTIONAL_NAS_BOOL
    make
}

src_install() {
    cd "$SOURCE_DIR/build"
    make DESTDIR="$INSTALL_DIR" install

    # create convenience symlinks
    install -vdm755 "$INSTALL_DIR/usr/bin"
    for file in "$INSTALL_DIR/usr/lib/katie/bin/"*;do
        # ln -sfv ../lib/katie/bin/$(basename "$file") "$INSTALL_DIR/usr/bin/$(basename $file)"
        ln -sfv ../lib/katie/bin/$(basename "$file") "$INSTALL_DIR/usr/bin/$(basename $file)-katie"
    done

    # register Designer as application
    install -vDm644 ../katie.git/src/tools/designer/images/designer.png \
        "$INSTALL_DIR/usr/share/pixmaps/designer-katie.png"
    install -vDm644 ../katie.git/src/tools/qdbusviewer/images/qdbusviewer.png \
        "$INSTALL_DIR/usr/share/pixmaps/qdbusviewer-katie.png"
    mkdir -p "$INSTALL_DIR/usr/share/applications"
    cat > "$INSTALL_DIR/usr/share/applications/designer-katie.desktop" << EOF
[Desktop Entry]
Name=Katie Designer
Comment=Design GUIs for Katie applications
Exec=designer-katie
Icon=designer-katie.png
MimeType=application/x-designer;
Terminal=false
Encoding=UTF-8
Type=Application
Categories=Qt;Development;
EOF
    cat > "$INSTALL_DIR/usr/share/applications/qdbusviewer-katie.desktop" << EOF
[Desktop Entry]
Name=Katie D-Bus Viewer
Comment=Debug D-Bus applications
Exec=qdbusviewer-katie
Icon=qdbusviewer-katie.png
Terminal=false
Encoding=UTF-8
Type=Application
Categories=Qt;Development;Debugger;
EOF
}

